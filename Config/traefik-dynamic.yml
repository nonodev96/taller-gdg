tcp:
  # ======================================
  # Middlewares TCP
  # ======================================
  middlewares:
    ip-allow-list-admin-TCP:
      ipAllowList:
        sourceRange:
          - 127.0.0.1 # localhost
          - 192.168.1.100 # PC Hogar

  # ======================================
  # Routers TCP
  # ======================================
  routers:
    minecraft:
      rule: "HostSNI(`*`)"
      entryPoints:
        - minecraft
      middlewares:
        - ip-allow-list-admin-TCP@file
      service: "minecraft-svc-TCP"

  # ======================================
  # Services TCP
  # ======================================
  services:
    minecraft-svc-TCP:
      loadBalancer:
        servers:
          - address: "traefik_minecraft:25565"

http:
  # ======================================
  # Middlewares
  # ======================================
  middlewares:
    sablier-whoami:
      plugin:
        plugin-traefik-sablier:
          sablierUrl: http://traefik_sablier:10000
          names: taller_gdg_traefik_whoami
          group:
            default # Will wake up all containers with label sablier.group=whoami
            # - whoami
          sessionDuration: 10m
          dynamic:
            # (Optional) Defaults to the middleware name
            displayName: Cargando whoami
            # (Optional) Set to true or false to show details specifcally for this middleware, unset to use Sablier server defaults
            showDetails: true
            # (Optional) The theme to use
            theme: hacker-terminal
            # (Optional) The loading page refresh frequency
            refreshFrequency: 5s

    # Plugins AUTH
    auth-github-oauth:
      plugin:
        plugin-traefik-github-oauth:
          logLevel: debug
          authPath: /_auth
          apiBaseUrl: https://traefik-github.nonodev96.dev
          whitelist:
            logins:
              - nonodev96

    # Plugins WAF
    waf-modsecurity:
      plugin:
        plugin-traefik-modsecurity:
          maxBodySize: 10485760
          modSecurityUrl: "http://traefik_waf:8080"

    # Middlewares
    ip-allow-list-admin:
      ipAllowList:
        sourceRange:
          - 127.0.0.1     # localhost
          - 192.168.1.100 # IP Fija
          - 172.20.0.5    # WSL

    # Middlewares
    compress:
      compress:
        minResponseBodyBytes: 1200
        excludedContentTypes:
          - text/event-stream

    # ======================================
    # Chain Middlewares
    # ======================================
    secure-private:
      chain:
        middlewares:
          # - ip-allow-list-admin
          # - auth-github-oauth
          - waf-modsecurity
          - compress

    secure-protected:
      chain:
        middlewares:
          - auth-github-oauth
          - waf-modsecurity
          - compress

    secure-public:
      chain:
        middlewares:
          - waf-modsecurity
          - compress

  # ======================================
  # Routers
  # ======================================
  routers:
    traefik-dashboard:
      rule: "Host(`traefik.nonodev96.dev`)"
      service: "api@internal"
      entryPoints:
        - traefik
        - websecure
      tls:
        domains:
          - main: "nonodev96.dev"
            sans:
              - "*.nonodev96.dev"

    uptime:
      rule: "Host(`uptime.nonodev96.dev`)"
      entryPoints:
        - websecure
      middlewares:
        - secure-private@file
      service: "uptime-svc"
      tls: {}

    whoami:
      rule: "Host(`whoami.nonodev96.dev`)"
      entryPoints:
        - websecure
      middlewares:
        - sablier-whoami@file
        - secure-public@file
      service: "whoami-svc"
      tls: {}

    photoprism:
      rule: "Host(`photoprism.nonodev96.dev`)"
      entryPoints:
        - websecure
      middlewares:
        - secure-public@file
      service: "photoprism-svc"
      tls: {}

  # ======================================
  # Services
  # ======================================
  services:
    whoami-svc:
      loadBalancer:
        servers:
          - url: "http://traefik_whoami:80"

    uptime-svc:
      loadBalancer:
        servers:
          - url: "http://traefik_uptime_kuma:3001"

    photoprism-svc:
      loadBalancer:
        servers:
          - url: "http://traefik_photoprism:2342"
        passHostHeader: true

tls:
  options:
    default:
      sniStrict: true
  certificates:
    - certFile: "/etc/certs/taller-cert.pem"
      keyFile: "/etc/certs/taller-key.pem"
